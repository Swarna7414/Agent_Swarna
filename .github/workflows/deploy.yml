name: CI/CD and Deploy to Hugging Face

on:
  push:
    branches: [ Production, main, master ]
  pull_request:
    branches: [ Production, main, master ]
  workflow_dispatch:

jobs:
  test-and-build:
    name: Test, Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests
    
    - name: Validate Dockerfile
      run: |
        if [ ! -f Dockerfile ]; then
          echo "âŒ Dockerfile not found!"
          exit 1
        fi
        echo "âœ… Dockerfile found"
    
    - name: Check required files
      run: |
        echo "Checking required files..."
        [ -f "Swarna.py" ] || (echo "âŒ Swarna.py not found" && exit 1)
        [ -f "requirements.txt" ] || (echo "âŒ requirements.txt not found" && exit 1)
        [ -f "Dockerfile" ] || (echo "âŒ Dockerfile not found" && exit 1)
        [ -f "Agent/Agent_Swarna.zip" ] || (echo "âŒ Agent/Agent_Swarna.zip not found" && exit 1)
        echo "âœ… All required files present"
    
    - name: Validate Python syntax
      run: |
        python -m py_compile Swarna.py
        python -m py_compile PriceFetcher/BitcoinPriceFetcher.py
        python -m py_compile SentimentAnalyzer/NewsSentimentAnalyzer.py
        echo "âœ… Python syntax validation passed"
    
    - name: Check health endpoint
      run: |
        python -c "
        import re
        with open('Swarna.py', 'r') as f:
            content = f.read()
        if '@app.get(\"/health\")' in content or '@app.get(\"/health\")' in content:
            print('âœ… Health endpoint found in code')
        else:
            print('âŒ Health endpoint not found')
            exit(1)
        "
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: agent-swarna:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Verify Docker image
      run: |
        docker images | grep agent-swarna
        echo "âœ… Docker image built successfully"
    
    - name: Deploy to Hugging Face Spaces
      if: github.event_name == 'push' && (github.ref == 'refs/heads/Production' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        echo "ðŸš€ Deploying to Hugging Face Spaces..."
        
        # Install Hugging Face Hub CLI
        pip install huggingface_hub
        
        # Clone the Hugging Face Space repository
        git clone https://${{ secrets.HF_TOKEN }}@huggingface.co/spaces/SaiSankarSwarna/Agent_Swarna.git hf-space || true
        
        cd hf-space
        
        # Copy files to Hugging Face Space
        cp ../Swarna.py .
        cp ../Dockerfile .
        cp ../requirements.txt .
        cp ../README.md .
        cp -r ../Agent .
        cp -r ../PriceFetcher .
        cp -r ../SentimentAnalyzer .
        cp ../.dockerignore .
        
        # Commit and push to Hugging Face
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "Deploy from GitHub Actions - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push origin main
        
        echo "âœ… Successfully deployed to Hugging Face Spaces!"
        echo "ðŸ”— Space URL: https://huggingface.co/spaces/SaiSankarSwarna/Agent_Swarna"
    
    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "- Dockerfile: âœ… Present" >> $GITHUB_STEP_SUMMARY
        echo "- Main Application: âœ… Present" >> $GITHUB_STEP_SUMMARY
        echo "- Agent Model: âœ… Present" >> $GITHUB_STEP_SUMMARY
        echo "- Requirements: âœ… Present" >> $GITHUB_STEP_SUMMARY
        echo "- Health Endpoint: âœ… Present" >> $GITHUB_STEP_SUMMARY
        echo "- Docker Build: âœ… Successful" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" == "push" ]; then
          echo "- Hugging Face Deployment: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Space Information" >> $GITHUB_STEP_SUMMARY
        echo "- Space: [SaiSankarSwarna/Agent_Swarna](https://huggingface.co/spaces/SaiSankarSwarna/Agent_Swarna)" >> $GITHUB_STEP_SUMMARY
        echo "- Health Endpoint: \`/health\`" >> $GITHUB_STEP_SUMMARY

